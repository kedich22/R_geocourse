---
title: <div align = "center"> __Задание 7__
author: <div align = "right"> *Андрей Кедич*
output: html_document
---

## Основы статистики

Подключение библиотек:
```{r, message = F}
library(tidyverse)
library(googlesheets4)
library(rlang)
library(lubridate)
```

Загрузка каталога метеостанций:
```{r,message = F}
catalog <- read_sheet('1Q6HCY4jxiYefjPdWrN5erwgEee-Gz_BywqZW2mQcftw')
```
Загрузка и выполнение преобразований с помощью пайп-оператора данных по метеостанциям:
```{r, message = F, warning = F}
meteo_data <- lapply(as.character(catalog$ID), function(X) read_sheet('1FWC_YBrlINnjR5POC2kxa_LnLC7n5fFA90oNA7dLTP0', sheet = X, col_types = 'ccncccnninncnnnnncc')) %>% 
  set_names(catalog$ID) %>% 
  bind_rows(.id = 'id') %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(catalog, by = c('id' = 'ID')) %>% 
  mutate(Datetime = as.POSIXct(Datetime)) %>% 
  relocate(id, .before = NAME) %>% 
  set_names(c('Datetime', 'Wdir', 'Wspd', 'Vis', 'Phen', 'Cloud', 'T', 'Td', 'F', 'Te', 'Tes', 'Comf', 'P', "Po", 'Tmin', 'Tmax', 'R', 'R24', 'S', 'ID', 'NAME', 'LON', 'LAT', 'H'))
```

Итоговая таблицы данных по метеостанциям:
```{r}
meteo_data
```

Фильтрация данных (только метеостанции Балчуг и Малое Сареево):
```{r, message = F}
filter_data <- meteo_data %>% 
  filter(str_detect(NAME, 'Балчуг') | str_detect(NAME, 'Сареево'))
print(filter_data)
```

Фильтрация данных (только ночные измерения 0:00 и 3:00):
```{r}
filter_data_night <- filter_data %>% 
  filter(hour(Datetime) == 0 | hour(Datetime) == 3)
print(filter_data_night)
```

Построение графика плотности распределения температур:
```{r}
ggplot(filter_data, mapping = aes(Datetime, `T`, color = NAME)) +
  geom_point(alpha = 0.1) +
  geom_density_2d() +
  ggtitle('Плотности распределения температур на станциях "Малое Сараево", "Балчуг"') +
  ylab('C°') +
  xlab('Месяц') +
  labs(color = 'Метеостанция')
```

На основе анализа построенного графика можно сказать, что для Малого Сареева характерны большее количество низких температур по сравнению с центром Москвы (Балчуг)

Построение графика плотности распределения ночных температур:
```{r}
ggplot(filter_data_night, mapping = aes(Datetime, `T`, color = NAME)) +
  geom_point(alpha = 0.5) +
  geom_density_2d() +
  ggtitle('Плотности распределения ночных температур на станциях "Малое Сараево", "Балчуг"') +
  ylab('C°') +
  xlab('Месяц') +
  labs(color = 'Метеостанция')
```

По данному графику можно отметить, что зимние температуры в центре Москвы в целом выше температур в пригороде. Особенно это выделяется в сентябре.

Построение графика boxplot (диграммы размаха) для общей выборки:
```{r}
ggplot(filter_data, mapping = aes(NAME, `T`, fill = NAME)) +
  geom_boxplot(alpha = 0.4, width = 0.6) +
  ylab('C°') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Диаграммы размаха температур на метеостанциях') +
  theme(legend.position="none")
```

Данные диаграммы лишний раз и более отчетиливо подчериквают выявленные различия в разнице температур.

Построение графика boxplot (диграммы размаха) для ночной выборки:
```{r}
ggplot(filter_data_night, mapping = aes(NAME, `T`, fill = NAME)) +
  geom_boxplot(alpha = 0.4, width = 0.6) +
  ylab('C°') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Диаграммы размаха температур на метеостанциях') +
  theme(legend.position="none")
```

Данная диграмма показывает, что отличия между только ночными значениями разница средних значений больше по сравнению с общими температурами.

Применение теста Стьюдента для сравнения средних значений (общая выборка):
```{r}
t.test(filter_data %>% filter(ID == 27605) %>% pull(`T`),
       filter_data %>% filter(ID == 27518) %>% pull(`T`))
```

На основе полученного p-value можно принять гипотезу о неравенстве данных выборок.

Данная диграмма показывает, что отличия между только ночными значениями разница средних значений больше по сравнению с общими температурами.

Применение теста Фишера для сравнения дисперсии (общая выборка):
```{r}
var.test(filter_data %>% filter(ID == 27605) %>% pull(`T`),
       filter_data %>% filter(ID == 27518) %>% pull(`T`))
```

На основе полученного p-value можно сделать вывод, что в вариации не выявлено статистически значимых различий.

Применение теста Стьюдента для сравнения средних значений (ночная выборка):
```{r}
t.test(filter_data_night %>% filter(ID == 27605) %>% pull(`T`),
       filter_data_night %>% filter(ID == 27518) %>% pull(`T`))
```

На основе полученного p-value можно принять гипотезу о неравенстве данных выборок.

Данная диграмма показывает, что отличия между только ночными значениями разница средних значений больше по сравнению с общими температурами.

Применение теста Фишера для сравнения дисперсии (ночная выборка):
```{r}
var.test(filter_data_night %>% filter(ID == 27605) %>% pull(`T`), 
         filter_data_night %>% filter(ID == 27518) %>% pull(`T`))
```

На основе полученного p-value можно сделать вывод, что в вариации не выявлено статистически значимых различий.

### Создание расчетного датафрейма (разниц температур)

Создание и преобразование датафрейма разниц температур на основе ранее скачанных данных, добавление столбцы со средней скоростью ветра:
```{r, message = F, warning = F}
dif_df = inner_join(filter_data %>% 
                          select(Datetime, `T`, ID, NAME) %>% 
                          filter(ID == 27605),
                          filter_data %>% 
                          select(Datetime, `T`, ID, NAME) %>% 
                          filter(ID == 27518),
                          by = 'Datetime') %>% 
  mutate(temp_dif = `T.x` - `T.y`) %>% 
  select(Datetime, temp_dif) %>% 
  inner_join(meteo_data %>% group_by(Datetime) %>% summarise(mean_wind_spd = round(mean(Wspd, na.rm = T), 2)))
```

Фильтрация и создание датафрейма с ночными температурами:
```{r, message = F}
dif_df_night <- dif_df %>% 
  filter(hour(Datetime) == 0 | hour(Datetime) == 3)
head(dif_df_night)
```

Построение диграммы рассеяния с линией регрессии между разницей температурой и высчитанной средней скоростью ветра в регионе (общая выборка температур):
```{r}
ggplot(dif_df, mapping = aes(mean_wind_spd, temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'loess', color = 'blue', size = 0.8, span = 0.5) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')
```

На основе графика можно сказать, что между этими двумя показателями отмечается нелинейная зависимость, также важно сказать, что при высоких значениях скорости отмечается некоторое количество выбросов, которые несколько искажают картину.Чем меньше скорость ветра - тем меньше разница температур

Построение диграммы рассеяния с линией регрессии между разницей температурой и высчитанной средней скоростью ветра в регионе (ночные температуры):
```{r}
ggplot(dif_df_night, mapping = aes(mean_wind_spd, temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'loess', color = 'blue', size = 0.8, span = 0.9) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей ночных температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')
```

Между двумя показателями можно выявить нелинейную регрессию - при наименьших скоростях ветра отмечаются наибольшие разницы температур.

Для применения коррелляцианных тестов необходимо провести линеаризацию (сделать регрессию линейной). Для этого был выбран способ логарифмирования одного из аргументов, в данном случае этот способ подходит больше всего.

Для общей выборки:
```{r}
ggplot(dif_df, mapping = aes(log10(mean_wind_spd), temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'lm', color = 'blue', size = 0.8) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab(expression('log'[10]*'(Скорость ветра), м/с')) +
  ylab('Разница температур, C°')
```

Для ночной выборки:
```{r}
ggplot(dif_df_night, mapping = aes(log10(mean_wind_spd), temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'lm', color = 'blue', size = 0.8) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab(expression('log'[10]*'(Скорость ветра), м/с')) +
  ylab('Разница температур, C°')  
```

### Проведение корреляционного теста и получение линейной модели регрессии

Проведение корреляционного теста (Пирсона) для общей выборки:
```{r}
cor.test(log10(dif_df$mean_wind_spd), dif_df$temp_dif)
```

На основе полученных данных можно сказать что величины имеют значительную обратную связь, так как значение всего -0.74.

Проведение корреляционного теста для ночной выборки:
```{r}
cor.test(log10(dif_df_night$mean_wind_spd), dif_df_night$temp_dif)
```

Выявлена значительная обратная связь. Можно отметить, что в ночное время связь более значительна (-0.79).

Получение модели линейной регрессии:
```{r, message = F}
linear_model = lm(log10(dif_df$mean_wind_spd) ~ dif_df$temp_dif)
summary(linear_model)
```

Получены данные: коэффициенты, интервал и статистика по отклонениям, среднеквадратическое отклонение и др.
